@page "/processes"
@using Slov89.PCStats.Data
@inject IMetricsService MetricsService
@rendermode InteractiveServer

<PageTitle>Processes</PageTitle>

<h1>Processes</h1>

<div class="mb-3">
    <button type="button" class="btn btn-success" @onclick="RefreshData">
        <span class="bi bi-arrow-clockwise"></span> Refresh
    </button>
    @if (lastUpdated.HasValue)
    {
        <span class="ms-2 text-muted">Last updated: @lastUpdated.Value.ToString("HH:mm:ss")</span>
    }
</div>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading process data...</p>
    </div>
}
else if (hasError)
{
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Error Loading Data</h4>
        <p>@errorMessage</p>
    </div>
}
else if (!processGroups.Any())
{
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">No Data Available</h4>
        <p>No process data found.</p>
    </div>
}
else
{
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 process-table">
                    <thead class="sticky-top">
                        <tr>
                            <th @onclick='() => SortBy("ProcessName")' style="cursor: pointer;">
                                Process Name @GetSortIcon("ProcessName")
                            </th>
                            <th @onclick='() => SortBy("CpuUsage")' style="cursor: pointer; text-align: right;">
                                CPU % @GetSortIcon("CpuUsage")
                            </th>
                            <th @onclick='() => SortBy("PrivateMemoryMb")' style="cursor: pointer; text-align: right;">
                                Private Memory (MB) @GetSortIcon("PrivateMemoryMb")
                            </th>
                            <th @onclick='() => SortBy("VramUsageMb")' style="cursor: pointer; text-align: right;">
                                VRAM (MB) @GetSortIcon("VramUsageMb")
                            </th>
                            <th @onclick='() => SortBy("ThreadCount")' style="cursor: pointer; text-align: right;">
                                Threads @GetSortIcon("ThreadCount")
                            </th>
                            <th @onclick='() => SortBy("HandleCount")' style="cursor: pointer; text-align: right;">
                                Handles @GetSortIcon("HandleCount")
                            </th>
                            <th @onclick='() => SortBy("FirstSeen")' style="cursor: pointer;">
                                First Seen @GetSortIcon("FirstSeen")
                            </th>
                            <th @onclick='() => SortBy("LastSeen")' style="cursor: pointer;">
                                Last Seen @GetSortIcon("LastSeen")
                            </th>
                            <th>Process Path</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int rowIndex = 0;
                        }
                        @foreach (var group in GetSortedGroups())
                        {
                            var isExpanded = expandedProcesses.Contains(group.ProcessName);
                            var rowClass = rowIndex % 2 == 0 ? "even-row" : "odd-row";
                            rowIndex++;

                            <tr class="parent-row @rowClass" @onclick="() => ToggleExpand(group.ProcessName)" style="cursor: pointer;">
                                <td>
                                    <span class="expand-icon">@(isExpanded ? "▼" : "▶")</span>
                                    <strong>@group.ProcessName</strong>
                                    @if (group.Count > 1)
                                    {
                                        <span class="badge bg-secondary ms-2">@group.Count</span>
                                    }
                                </td>
                                <td style="text-align: right;">@($"{group.TotalCpuUsage:F2}")</td>
                                <td style="text-align: right;">@group.TotalPrivateMemoryMb.ToString("N0")</td>
                                <td style="text-align: right;">@group.TotalVramUsageMb.ToString("N0")</td>
                                <td style="text-align: right;">@group.TotalThreadCount.ToString("N0")</td>
                                <td style="text-align: right;">@group.TotalHandleCount.ToString("N0")</td>
                                <td>@group.FirstSeen.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>@group.LastSeen.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td class="process-path">@group.ProcessPath</td>
                            </tr>

                            @if (isExpanded && group.Count > 1)
                            {
                                @foreach (var process in group.Processes)
                                {
                                    var childRowClass = rowIndex % 2 == 0 ? "even-row" : "odd-row";
                                    rowIndex++;

                                    <tr class="child-row @childRowClass">
                                        <td style="padding-left: 40px;">
                                            <span class="text-muted">PID: @process.Pid</span>
                                        </td>
                                        <td style="text-align: right;">@($"{process.CpuUsage ?? 0:F2}")</td>
                                        <td style="text-align: right;">@((process.PrivateMemoryMb ?? 0).ToString("N0"))</td>
                                        <td style="text-align: right;">@((process.VramUsageMb ?? 0).ToString("N0"))</td>
                                        <td style="text-align: right;">@((process.ThreadCount ?? 0).ToString("N0"))</td>
                                        <td style="text-align: right;">@((process.HandleCount ?? 0).ToString("N0"))</td>
                                        <td>@process.FirstSeen.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>@process.LastSeen.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td class="process-path">@process.ProcessPath</td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3 text-muted">
        <small>Total: @processGroups.Count process groups, @processGroups.Sum(g => g.Count) individual processes</small>
    </div>
}

<style>
    .process-table {
        font-size: 0.9rem;
    }

    .process-table thead th {
        background-color: #1a1a1a;
        border-bottom: 2px solid #444;
        padding: 12px 8px;
        font-weight: 600;
        white-space: nowrap;
    }

    .process-table thead th:hover {
        background-color: #2a2a2a;
    }

    .process-table tbody td {
        padding: 10px 8px;
        vertical-align: middle;
        border-bottom: 1px solid #333;
    }

    .parent-row {
        font-weight: 500;
    }

    .parent-row:hover {
        background-color: #2a3a4a !important;
    }

    .child-row {
        font-size: 0.85rem;
    }

    .child-row:hover {
        background-color: #2a3a4a !important;
    }

    .even-row {
        background-color: #1e1e1e;
    }

    .odd-row {
        background-color: #252525;
    }

    .expand-icon {
        display: inline-block;
        width: 20px;
        color: #6c757d;
        font-size: 0.8rem;
    }

    .process-path {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.8rem;
        color: #888;
    }

    .table-responsive {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>

@code {
    private List<ProcessSnapshotDetail> processes = new();
    private List<ProcessGroup> processGroups = new();
    private HashSet<string> expandedProcesses = new();
    private bool isLoading = true;
    private bool hasError = false;
    private string errorMessage = string.Empty;
    private DateTime? lastUpdated;
    private string sortColumn = "PrivateMemoryMb";
    private bool sortDescending = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        hasError = false;
        errorMessage = string.Empty;

        try
        {
            processes = await MetricsService.GetLatestProcessSnapshotsAsync();
            
            // Group processes by name
            processGroups = processes
                .GroupBy(p => p.ProcessName)
                .Select(g => new ProcessGroup
                {
                    ProcessName = g.Key,
                    Processes = g.OrderBy(p => p.Pid).ToList(),
                    Count = g.Count(),
                    TotalCpuUsage = g.Sum(p => p.CpuUsage ?? 0),
                    TotalPrivateMemoryMb = g.Sum(p => p.PrivateMemoryMb ?? 0),
                    TotalVramUsageMb = g.Sum(p => p.VramUsageMb ?? 0),
                    TotalThreadCount = g.Sum(p => p.ThreadCount ?? 0),
                    TotalHandleCount = g.Sum(p => p.HandleCount ?? 0),
                    FirstSeen = g.Min(p => p.FirstSeen),
                    LastSeen = g.Max(p => p.LastSeen),
                    ProcessPath = g.First().ProcessPath ?? string.Empty
                })
                .ToList();

            lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleExpand(string processName)
    {
        if (expandedProcesses.Contains(processName))
        {
            expandedProcesses.Remove(processName);
        }
        else
        {
            expandedProcesses.Add(processName);
        }
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortDescending = !sortDescending;
        }
        else
        {
            sortColumn = column;
            sortDescending = true; // Always start with descending
        }
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column)
            return "";

        return sortDescending ? "▼" : "▲";
    }

    private IEnumerable<ProcessGroup> GetSortedGroups()
    {
        var groups = processGroups.AsEnumerable();

        groups = sortColumn switch
        {
            "ProcessName" => sortDescending 
                ? groups.OrderByDescending(g => g.ProcessName) 
                : groups.OrderBy(g => g.ProcessName),
            "CpuUsage" => sortDescending 
                ? groups.OrderByDescending(g => g.TotalCpuUsage) 
                : groups.OrderBy(g => g.TotalCpuUsage),
            "PrivateMemoryMb" => sortDescending 
                ? groups.OrderByDescending(g => g.TotalPrivateMemoryMb) 
                : groups.OrderBy(g => g.TotalPrivateMemoryMb),
            "VramUsageMb" => sortDescending 
                ? groups.OrderByDescending(g => g.TotalVramUsageMb) 
                : groups.OrderBy(g => g.TotalVramUsageMb),
            "ThreadCount" => sortDescending 
                ? groups.OrderByDescending(g => g.TotalThreadCount) 
                : groups.OrderBy(g => g.TotalThreadCount),
            "HandleCount" => sortDescending 
                ? groups.OrderByDescending(g => g.TotalHandleCount) 
                : groups.OrderBy(g => g.TotalHandleCount),
            "FirstSeen" => sortDescending 
                ? groups.OrderByDescending(g => g.FirstSeen) 
                : groups.OrderBy(g => g.FirstSeen),
            "LastSeen" => sortDescending 
                ? groups.OrderByDescending(g => g.LastSeen) 
                : groups.OrderBy(g => g.LastSeen),
            _ => groups.OrderByDescending(g => g.TotalPrivateMemoryMb)
        };

        return groups;
    }

    private class ProcessGroup
    {
        public string ProcessName { get; set; } = string.Empty;
        public List<ProcessSnapshotDetail> Processes { get; set; } = new();
        public int Count { get; set; }
        public decimal TotalCpuUsage { get; set; }
        public long TotalPrivateMemoryMb { get; set; }
        public long TotalVramUsageMb { get; set; }
        public int TotalThreadCount { get; set; }
        public int TotalHandleCount { get; set; }
        public DateTime FirstSeen { get; set; }
        public DateTime LastSeen { get; set; }
        public string ProcessPath { get; set; } = string.Empty;
    }
}
